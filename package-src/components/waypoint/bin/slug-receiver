#!/bin/bash
set -eo pipefail

function announce { 
  msg="---> $1"
  echo -e "\e[1;33m${msg}\e[0m"
}
function indent_output { 
  sed -u 's/^/     /'
}


consul-leader || (echo "no cluster leader. Aborting" && exit 1)

#if cat /cluster/etc/harbor_role | grep -G "$role" &> /dev/null; then

role="$(echo "$1" | awk -F'/' '{print $1}')"
repository="$(echo "$1" | awk -F'/' '{print $2}')"

# revision uses only 7 chars
revision="${2:0:7}"


# TODO extract it from repo name


# TODO check repo's in format role/app
announce "Processing $repository"
app_folder="$HOME/slugs/$role/$repository"
revision_folder="$app_folder/$revision"
mkdir -p "$revision_folder"
cd "$revision_folder"

announce "Saving revision source"

cat - | tar xf -

builder="$(cat Seafile | grep builder | awk '{print $2}')"

announce "Getting last version of builder image"
docker -H "tcp://localhost:2375" pull "$builder" 1> /dev/null

announce "Building $image_name with $builder"
image_name="$role/$repository"
sti build . "$builder" "$image_name" -U "tcp://localhost:2375" 2>&1 | indent_output

registry_image_name="localhost:5000/$image_name:$revision"
docker -H "tcp://localhost:2375" tag "$image_name" "$registry_image_name"

announce "Pushing resulting image to the cluster's registry"

docker -H "tcp://localhost:2375" push "$registry_image_name" 1> /dev/null | indent_output

announce "Saving information to distributed KV storage"

# consul namespaces
app_cns="app/$repository"
revisions_cns="$app_cns/revisions"
latest_revision_key="$revisions_cns/latest"
previous_revision_key="$revisions_cns/previous"

consulkv set $previous_revision_key $(consulkv get $latest_revision_key)
consulkv set $latest_revision_key $revision

function revision_data() {
  printf '{"receiver":"%s","role":"%s", "date":"%s"}' \
    "$(hostname)" "$(iso-date)" "$role"
}

consulkv set $revisions_cns/$revision "$(revision_data)"

consulkv set "$app_cns/instances" 1

# TODO confirm the app is deployed by the consul kv watchers

#announce "Annoucing new revision to the cluster"
#nsq_trigger received "$repository"

#announce "Triggering cluster balance event"
#nsq_trigger balance $role

announce "Thank your for pushing!"


# poll the cluster for information
# check the status is ok and app's been announced
# exit