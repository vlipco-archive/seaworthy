- name: "{{component}}: Loading installation variables"
  include_vars: install.yml

- name: "{{component}}: Creating component folders"
  file:
    path: "{{item}}"
    state: directory
  with_items:
    - "{{target_dir}}"
    - "{{consul_conf_dir}}"

- name: "{{component}}: Copying bin"
  with_fileglob: binaries_glob
  copy:
    mode: 0755
    src: "{{item}}"
    dest: "{{bin_dir}}/"

- name: "{{component}}: Copying consul checks"
  with_fileglob: consul_checks_glob
  copy:
    mode: 0755
    src: "{{item}}"
    dest: "{{checks_dir}}/"

- name: "{{component}}: Copying event handlers"
  with_fileglob: event_handlers_glob
  copy:
    mode: 0755
    src: "{{item}}"
    dest: "{{event_handlers_dir}}/"

- name: "{{component}}: Compiling consul templates"
  with_fileglob: consul_templates_glob
  template:
    src: "{{item}}"
    dest: >
      {{consul_conf_dir}}/{{item|regex_replace('(.*\/)([^\.]*)(\..*)', '\\2') }}.json

- name: "{{component}}: Copying systemd units"
  with_fileglob: systemd_units_glob
  register: units_install
  copy:
    src: "{{item}}"
    dest: "{{systemd_dir}}/"

- name: "{{component}}: Linking component parts"
  script: "generic_install/link-cluster-component {{component}}"
  notify: prune links

- name: "{{component}}: Notifying component's systemd handler"
  command: /bin/true
  with_fileglob: systemd_units_glob
  notify: "restart {{component}}"
