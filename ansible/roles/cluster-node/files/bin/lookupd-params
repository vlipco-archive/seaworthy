#!/bin/bash
set -eo pipefail

# ask the local consul agent where to find nsqlookupd
# services with tcp port. This can be used for nsqd.

proto=${1:-tcp}

if [[ "$proto" == "tcp" ]] ; then
	port=4160
elif [[ "$proto" == "http" ]] ; then
	port=4161
else
	echo "Unkown protocol $proto"
	exit 1
fi

if consul-leader &> /dev/null; then
	curl -s --max-time 1 "127.0.0.1:8500/v1/catalog/service/lookupd" \
	| jq "[.[] | .Address+(\":${port}\")]" \
	| jq -r "[\"--lookupd-${proto}-address=\"+.[]+\" \"] | add"

	# the first result is an array of strings like:
	# ["10.0.77.10:4160","10.0.77.20:4160","10.0.77.30:4160"]
	# that output becomes a set of addresses with the second pipe
	# the final output looks like:
	# -lookupd-tcp-address 10.0.77.10:4160 -lookupd-tcp-address 10.0.77.20:4160 ...
else
	echo "no cluster leader"
	exit 128
fi