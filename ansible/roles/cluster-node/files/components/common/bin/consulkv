#!/bin/bash
set -eo pipefail

curl_failed() {
	echo "Curl or piped processors failed."
	exit 1
}

get_key() {
	curl -s "http://127.0.0.1:8500/v1/kv/$1" \
	| jq -r '.[0].Value' \
	| base64 --decode || curl_failed
}
put_data() {
	curl -s "http://127.0.0.1:8500/v1/kv/$key" -X PUT --data @-
}

if [ -n "$1" ] && [ -n "$2" ]; then
	key="$1"
	shift # now $@ contains all other args besides the key
	echo "$@" | put_data || curl_failed

elif [ -n "$1" ]; then
	echo $(get_key $1)

else
	echo "Please provide either 1 or 2 parameters to get or set a value"
	exit 1
fi
