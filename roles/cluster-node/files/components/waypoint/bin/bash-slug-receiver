#!/bin/bash

consul-leader || (echo "no cluster leader. Aborting" && exit 1)

repository="$1"
revision="$2"
slugname="${repository}-${revision}"
role="external"

echo "----> Processing $slugname"

cd ~/slugs

# scope per role
mkdir -p "$role"
cd "$role"

mkdir -p "$repository"
cd "$repository"

echo "----> Saving revision information"

cat > "$revision.tar"

app_folder="apps/$role/$repository"

revisions_folder="$app_folder/revisions"
latest_revision_key="$revisions_folder/latest"
previous_revision_key="$revisions_folder/previous"

consulkv $previous_revision_key $(consulkv $latest_revision_key)
consulkv $latest_revision_key $revision

function revision_data() {
  printf '{"receiver_hostname":"%s","date":"%s","role":"%s"}' \
    "$(hostname)" "$(iso-date)" "$role"
}
#echo revision_data
consulkv $revisions_folder/$revision "$(revision_data)"

consulkv "$app_folder/instances" 1

echo "----> Annoucing new revision to the cluster"
nsq_trigger received "$repository"

echo "----> Triggering cluster balance event"
nsq_trigger balance $role

echo "----> Thank your for pushing!"


# poll the cluster for information
# check the status is ok and app's been announced
# exit