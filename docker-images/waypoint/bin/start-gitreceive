#!/bin/bash
set -eo pipefail

# The port is defined by forego as env var

ssh_key="/etc/ssh/ssh_host_dsa_key"
cache_dir="/srv/data/repos"
receiver="/usr/local/bin/build-slug"

# no auth here, that's the hosts responsability
fake_auth_checker="/bin/true"

if [[ ! -e "$ssh_key" ]]; then
	/usr/bin/ssh-keygen -t dsa -N '' -f $ssh_key
fi

exec /usr/local/bin/gitreceived -k="$ssh_key" -r="$cache_dir" -p="5000" \
	$ssh_key $fake_auth_checker	$receiver