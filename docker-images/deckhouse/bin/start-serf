#!/bin/bash
set -eo pipefail

function abort() {
  echo "FATAL: $1" && exit 1
}

function ensure_defined() {
  if [[ -z "${!1}" ]] ; then
    abort "$1 isn't defined in the environment and it's required to start Serf"
  fi
}

ensure_defined "SERF_ROUTABLE_IP"
ensure_defined "SERF_NODE_NAME"
ensure_defined "SERF_BIND_PORT"
ensure_defined "SERF_JOIN_NODE"
ensure_defined "SERF_ROLE"

if [[ -n "$SERF_SECRET" ]]; then
	# a serf secret was given
	SECURITY_OPTIONS="-encrypt $SERF_SECRET"
else
	SECURITY_OPTIONS=""
fi

TAGS_OPTIONS="-tag type=container,role=$SERF_ROLE,start_time=$(date +%s)"

if [[ -n "$SERF_TAGS" ]]; then
	# extra tags were passed
	TAGS_OPTIONS="$TAGS_OPTIONS,$SERF_TAGS"
fi

SERF_BIND="$SERF_ROUTABLE_IP:$SERF_BIND_PORT"

# TODO support -snapshot 

/srv/bin/serf agent -join $SERF_JOIN_NODE -node $SERF_NODE_NAME \
		-bind 0.0.0.0:$SERF_BIND_PORT -advertise $SERF_BIND \
		$TAGS_OPTIONS $SECURITY_OPTIONS \
		-event-handler /srv/bin/event-router